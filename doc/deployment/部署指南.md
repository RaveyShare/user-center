# 部署指南

## 概述

本文档基于真实的配置文件，描述了用户中心系统的部署流程，包括环境准备、配置说明、部署步骤等。

## 系统要求

### 硬件要求

| 环境 | CPU | 内存 | 存储 | 网络 |
|------|-----|------|------|------|
| 开发环境 | 2核 | 4GB | 20GB | 10Mbps |
| 测试环境 | 2核 | 8GB | 50GB | 50Mbps |
| 生产环境 | 4核 | 16GB | 200GB | 100Mbps |

### 软件要求

| 组件 | 版本要求 | 说明 |
|------|----------|------|
| Java | JDK 17+ | 推荐使用 OpenJDK 17 |
| Maven | 3.8+ | 构建工具 |
| MySQL | 8.0+ | 数据库 |
| Redis | 6.0+ | 缓存（可选） |
| Nginx | 1.20+ | 反向代理（生产环境） |

## 环境准备

### 1. Java 环境安装

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install openjdk-17-jdk

# CentOS/RHEL
sudo yum install java-17-openjdk-devel

# 验证安装
java -version
javac -version
```

### 2. Maven 安装

```bash
# 下载并安装 Maven
wget https://archive.apache.org/dist/maven/maven-3/3.9.4/binaries/apache-maven-3.9.4-bin.tar.gz
tar -xzf apache-maven-3.9.4-bin.tar.gz
sudo mv apache-maven-3.9.4 /opt/maven

# 配置环境变量
echo 'export MAVEN_HOME=/opt/maven' >> ~/.bashrc
echo 'export PATH=$MAVEN_HOME/bin:$PATH' >> ~/.bashrc
source ~/.bashrc

# 验证安装
mvn -version
```

### 3. MySQL 安装与配置

```bash
# Ubuntu/Debian
sudo apt install mysql-server

# CentOS/RHEL
sudo yum install mysql-server

# 启动 MySQL 服务
sudo systemctl start mysql
sudo systemctl enable mysql

# 安全配置
sudo mysql_secure_installation
```

#### MySQL 配置优化

编辑 `/etc/mysql/mysql.conf.d/mysqld.cnf`：

```ini
[mysqld]
# 基础配置
port = 3306
bind-address = 0.0.0.0
max_connections = 1000
max_connect_errors = 10000

# 字符集配置
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci

# InnoDB 配置
innodb_buffer_pool_size = 1G
innodb_log_file_size = 256M
innodb_flush_log_at_trx_commit = 2
innodb_flush_method = O_DIRECT

# 查询缓存
query_cache_type = 1
query_cache_size = 128M

# 慢查询日志
slow_query_log = 1
slow_query_log_file = /var/log/mysql/slow.log
long_query_time = 2
```

### 4. Redis 安装（可选）

```bash
# Ubuntu/Debian
sudo apt install redis-server

# CentOS/RHEL
sudo yum install redis

# 启动 Redis 服务
sudo systemctl start redis
sudo systemctl enable redis

# 验证安装
redis-cli ping
```

## 数据库初始化

### 1. 创建数据库

```sql
-- 连接到 MySQL
mysql -u root -p

-- 创建数据库
CREATE DATABASE user_center CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 创建用户
CREATE USER 'user_center'@'%' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON user_center.* TO 'user_center'@'%';
FLUSH PRIVILEGES;
```

### 2. 执行初始化脚本

```bash
# 进入项目目录
cd /path/to/user-center

# 执行初始化脚本
mysql -u user_center -p user_center < doc/sql/init.sql
```

## 应用配置

### 1. 配置文件说明

主要配置文件位于 `user-center-start/src/main/resources/`：

- `application.yml` - 主配置文件
- `application-dev.yml` - 开发环境配置
- `application-test.yml` - 测试环境配置
- `application-prod.yml` - 生产环境配置

### 2. 生产环境配置示例

创建 `application-prod.yml`：

```yaml
server:
  port: 8080
  servlet:
    context-path: /

spring:
  datasource:
    url: jdbc:mysql://localhost:3306/user_center?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai
    username: user_center
    password: ${DB_PASSWORD:your_password}
    driver-class-name: com.mysql.cj.jdbc.Driver
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000

  redis:
    host: localhost
    port: 6379
    password: ${REDIS_PASSWORD:}
    database: 0
    timeout: 3000
    lettuce:
      pool:
        max-active: 20
        max-idle: 10
        min-idle: 5

  jpa:
    hibernate:
      ddl-auto: validate
    show-sql: false
    properties:
      hibernate:
        dialect: org.hibernate.dialect.MySQL8Dialect
        format_sql: false

logging:
  level:
    com.ravey: INFO
    org.springframework.security: WARN
  file:
    name: /var/log/user-center/application.log
  logback:
    rollingpolicy:
      max-file-size: 100MB
      max-history: 30

management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics
  endpoint:
    health:
      show-details: when-authorized

# 微信小程序配置
wechat:
  mini-program:
    default-app-id: ${WX_DEFAULT_APP_ID:}
    default-app-secret: ${WX_DEFAULT_APP_SECRET:}

# JWT 配置
jwt:
  secret: ${JWT_SECRET:your-jwt-secret-key}
  expiration: 7200
```

### 3. 环境变量配置

创建 `/etc/systemd/system/user-center.service`：

```ini
[Unit]
Description=User Center Application
After=network.target mysql.service

[Service]
Type=forking
User=app
Group=app
WorkingDirectory=/opt/user-center
ExecStart=/opt/user-center/bin/start.sh
ExecStop=/opt/user-center/bin/stop.sh
Restart=always
RestartSec=10

Environment=SPRING_PROFILES_ACTIVE=prod
Environment=DB_PASSWORD=your_db_password
Environment=REDIS_PASSWORD=your_redis_password
Environment=JWT_SECRET=your_jwt_secret_key
Environment=WX_DEFAULT_APP_ID=your_wx_app_id
Environment=WX_DEFAULT_APP_SECRET=your_wx_app_secret

[Install]
WantedBy=multi-user.target
```

## 部署步骤

### 1. 构建应用

```bash
# 克隆代码
git clone https://github.com/ravey/user-center.git
cd user-center

# 构建项目
mvn clean package -DskipTests

# 验证构建结果
ls -la user-center-start/target/user-center-start-*.jar
```

### 2. 部署到服务器

```bash
# 创建应用目录
sudo mkdir -p /opt/user-center/{bin,config,logs}
sudo useradd -r -s /bin/false app
sudo chown -R app:app /opt/user-center

# 复制应用文件
sudo cp user-center-start/target/user-center-start-*.jar /opt/user-center/user-center.jar
sudo cp -r user-center-start/src/main/resources/* /opt/user-center/config/

# 创建启动脚本
sudo tee /opt/user-center/bin/start.sh > /dev/null << 'EOF'
#!/bin/bash
cd /opt/user-center
nohup java -jar \
  -Xms1g -Xmx2g \
  -Dspring.config.location=classpath:/,file:./config/ \
  -Dspring.profiles.active=prod \
  user-center.jar > logs/application.log 2>&1 &
echo $! > logs/application.pid
EOF

# 创建停止脚本
sudo tee /opt/user-center/bin/stop.sh > /dev/null << 'EOF'
#!/bin/bash
cd /opt/user-center
if [ -f logs/application.pid ]; then
  kill $(cat logs/application.pid)
  rm -f logs/application.pid
fi
EOF

# 设置执行权限
sudo chmod +x /opt/user-center/bin/*.sh
sudo chown -R app:app /opt/user-center
```

### 3. 配置系统服务

```bash
# 安装系统服务
sudo systemctl daemon-reload
sudo systemctl enable user-center

# 启动服务
sudo systemctl start user-center

# 检查服务状态
sudo systemctl status user-center

# 查看日志
sudo journalctl -u user-center -f
```

### 4. 配置 Nginx 反向代理

创建 `/etc/nginx/sites-available/user-center`：

```nginx
upstream user_center_backend {
    server 127.0.0.1:8080;
    # 如果有多个实例，可以添加更多服务器
    # server 127.0.0.1:8081;
}

server {
    listen 80;
    server_name your-domain.com;

    # 重定向到 HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;

    # SSL 证书配置
    ssl_certificate /path/to/your/certificate.crt;
    ssl_certificate_key /path/to/your/private.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;

    # 安全头
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload";

    # 日志配置
    access_log /var/log/nginx/user-center.access.log;
    error_log /var/log/nginx/user-center.error.log;

    # 代理配置
    location / {
        proxy_pass http://user_center_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 超时配置
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
        
        # 缓冲配置
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
    }

    # 健康检查
    location /health {
        proxy_pass http://user_center_backend/actuator/health;
        access_log off;
    }

    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

启用配置：

```bash
sudo ln -s /etc/nginx/sites-available/user-center /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

## 监控与运维

### 1. 应用监控

#### 健康检查

```bash
# 检查应用状态
curl http://localhost:8080/actuator/health

# 检查应用信息
curl http://localhost:8080/actuator/info

# 检查指标
curl http://localhost:8080/actuator/metrics
```

#### 日志监控

```bash
# 实时查看应用日志
tail -f /opt/user-center/logs/application.log

# 查看错误日志
grep ERROR /opt/user-center/logs/application.log

# 查看访问日志
tail -f /var/log/nginx/user-center.access.log
```

### 2. 数据库监控

```sql
-- 查看连接数
SHOW STATUS LIKE 'Threads_connected';

-- 查看慢查询
SHOW STATUS LIKE 'Slow_queries';

-- 查看表状态
SHOW TABLE STATUS FROM user_center;

-- 查看索引使用情况
SHOW INDEX FROM users;
```

### 3. 性能优化

#### JVM 调优

```bash
# 生产环境 JVM 参数建议
-Xms2g -Xmx4g
-XX:+UseG1GC
-XX:MaxGCPauseMillis=200
-XX:+HeapDumpOnOutOfMemoryError
-XX:HeapDumpPath=/opt/user-center/logs/
-XX:+PrintGCDetails
-XX:+PrintGCTimeStamps
-Xloggc:/opt/user-center/logs/gc.log
```

#### 数据库优化

```sql
-- 创建必要的索引
CREATE INDEX idx_user_apps_openid ON user_apps(openid);
CREATE INDEX idx_sessions_expire_time ON user_sessions(expire_time);

-- 定期清理过期数据
DELETE FROM user_sessions WHERE expire_time < NOW();
DELETE FROM qr_login_records WHERE expire_time < DATE_SUB(NOW(), INTERVAL 7 DAY);
```

### 4. 备份策略

#### 数据库备份

```bash
#!/bin/bash
# 数据库备份脚本
BACKUP_DIR="/backup/mysql"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="user_center_${DATE}.sql"

mkdir -p $BACKUP_DIR

mysqldump -u user_center -p user_center > $BACKUP_DIR/$BACKUP_FILE

# 压缩备份文件
gzip $BACKUP_DIR/$BACKUP_FILE

# 删除7天前的备份
find $BACKUP_DIR -name "*.gz" -mtime +7 -delete
```

#### 应用备份

```bash
#!/bin/bash
# 应用备份脚本
BACKUP_DIR="/backup/app"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR

# 备份应用文件
tar -czf $BACKUP_DIR/user-center_${DATE}.tar.gz /opt/user-center

# 删除30天前的备份
find $BACKUP_DIR -name "*.tar.gz" -mtime +30 -delete
```

## 故障排查

### 常见问题

1. **应用启动失败**
   - 检查 Java 版本和环境变量
   - 检查数据库连接配置
   - 查看启动日志

2. **数据库连接失败**
   - 检查数据库服务状态
   - 验证连接参数
   - 检查防火墙设置

3. **内存溢出**
   - 调整 JVM 堆内存大小
   - 分析堆转储文件
   - 检查内存泄漏

4. **性能问题**
   - 分析慢查询日志
   - 检查数据库索引
   - 监控系统资源使用

### 日志分析

```bash
# 分析错误日志
grep -i error /opt/user-center/logs/application.log | tail -20

# 分析访问模式
awk '{print $1}' /var/log/nginx/user-center.access.log | sort | uniq -c | sort -nr | head -10

# 分析响应时间
awk '{print $NF}' /var/log/nginx/user-center.access.log | sort -n | tail -20
```

## 安全建议

1. **网络安全**
   - 使用防火墙限制端口访问
   - 配置 SSL/TLS 证书
   - 定期更新系统补丁

2. **应用安全**
   - 定期更新依赖库
   - 配置安全头
   - 实施访问控制

3. **数据安全**
   - 加密敏感数据
   - 定期备份数据
   - 限制数据库访问权限

## 版本信息

- **文档版本**: 1.0.0
- **作者**: Ravey
- **最后更新**: 2024-01-01

## 联系方式

如需技术支持或有部署问题，请联系运维团队。