# 数据库设计说明

## 概述

本文档基于真实的数据库 schema 文件，描述了用户中心系统的数据库设计，包括表结构、字段说明、索引设计等。

## 数据库表结构

### 1. 应用表 (apps)

应用表用于存储多应用系统中的应用信息。

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|----------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 应用主键ID |
| app_name | VARCHAR(100) | NOT NULL | 应用名称 |
| app_id | VARCHAR(100) | UNIQUE, NOT NULL | 应用唯一标识 |
| app_secret | VARCHAR(200) | NOT NULL | 应用密钥 |
| description | VARCHAR(500) | | 应用描述 |
| status | TINYINT | DEFAULT 1 | 应用状态：1-启用，0-禁用 |
| creator | VARCHAR(50) | | 创建者 |
| creator_id | VARCHAR(50) | | 创建者ID |
| create_time | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updater | VARCHAR(50) | | 更新者 |
| updater_id | VARCHAR(50) | | 更新者ID |
| update_time | DATETIME | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

**索引设计：**
- PRIMARY KEY: id
- UNIQUE KEY: app_id

### 2. 用户表 (users)

用户表用于存储用户基本信息。

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|----------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 用户主键ID |
| nickname | VARCHAR(100) | | 用户昵称 |
| avatar_url | VARCHAR(500) | | 用户头像URL |
| status | TINYINT | DEFAULT 1 | 用户状态：1-正常，0-禁用 |
| creator | VARCHAR(50) | | 创建者 |
| creator_id | VARCHAR(50) | | 创建者ID |
| create_time | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updater | VARCHAR(50) | | 更新者 |
| updater_id | VARCHAR(50) | | 更新者ID |
| update_time | DATETIME | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

**索引设计：**
- PRIMARY KEY: id

### 3. 用户应用关联表 (user_apps)

用户应用关联表用于存储用户在不同应用中的身份信息，实现微信小程序的 OpenID 与用户的关联。

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|----------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 关联主键ID |
| user_id | BIGINT | NOT NULL | 用户ID，关联 users 表 |
| app_id | BIGINT | NOT NULL | 应用ID，关联 apps 表 |
| openid | VARCHAR(100) | NOT NULL | 微信OpenID |
| unionid | VARCHAR(100) | | 微信UnionID |
| status | TINYINT | DEFAULT 1 | 关联状态：1-正常，0-禁用 |
| creator | VARCHAR(50) | | 创建者 |
| creator_id | VARCHAR(50) | | 创建者ID |
| create_time | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updater | VARCHAR(50) | | 更新者 |
| updater_id | VARCHAR(50) | | 更新者ID |
| update_time | DATETIME | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

**索引设计：**
- PRIMARY KEY: id
- UNIQUE KEY: uk_user_app (user_id, app_id) - 确保用户在每个应用中只有一条记录
- UNIQUE KEY: uk_app_openid (app_id, openid) - 确保每个应用中的OpenID唯一

### 4. 用户会话表 (user_sessions)

用户会话表用于存储用户登录会话信息，支持 JWT Token 管理。

| 字段名 | 数据类型 | 约束 | 说明 |
|--------|----------|------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | 会话主键ID |
| user_id | BIGINT | NOT NULL | 用户ID，关联 users 表 |
| app_id | BIGINT | | 应用ID，关联 apps 表 |
| session_token | VARCHAR(255) | NOT NULL | 会话令牌（JWT Token） |
| login_ip | VARCHAR(45) | | 登录IP地址（支持IPv6） |
| user_agent | VARCHAR(500) | | 用户代理信息 |
| expire_time | DATETIME | NOT NULL | 过期时间 |
| creator | VARCHAR(50) | | 创建者 |
| creator_id | VARCHAR(50) | | 创建者ID |
| create_time | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updater | VARCHAR(50) | | 更新者 |
| updater_id | VARCHAR(50) | | 更新者ID |
| update_time | DATETIME | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

**索引设计：**
- PRIMARY KEY: id

## 数据库设计原则

### 1. 多应用支持
- 通过 `apps` 表管理多个微信小程序
- `user_apps` 表建立用户与应用的多对多关系
- 支持同一用户在不同应用中的独立身份

### 2. 数据一致性
- 使用外键约束保证数据完整性
- 设置级联删除和更新策略
- 唯一约束防止重复数据

### 3. 性能优化
- 为常用查询字段创建索引
- 合理设计字段类型和长度
- 使用 InnoDB 存储引擎支持事务

### 4. 扩展性
- 预留扩展字段
- 统一的审计字段设计
- 支持软删除（status 字段）

## 初始化数据

数据库初始化时会插入两个示例应用：
1. 商城小程序 (wx1234567890abcdef)
2. 服务小程序 (wx0987654321fedcba)

## 维护说明

- **作者**: Ravey
- **版本**: 1.0.0
- **最后更新**: 随代码变更同步更新
- **备份策略**: 建议每日备份，保留30天历史数据

## 注意事项

1. **安全性**: app_secret 字段存储敏感信息，需要加密存储
2. **性能**: 定期清理过期的会话和二维码记录
3. **监控**: 建议对关键表设置监控告警
4. **索引维护**: 定期分析查询性能，优化索引策略