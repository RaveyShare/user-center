name: Build and Deploy to Aliyun

on:
  push:
    tags:
      - 'v*'  # åªåœ¨æ¨é€ tag æ—¶è§¦å‘éƒ¨ç½²
  workflow_dispatch:  # ä¿ç•™æ‰‹åŠ¨è§¦å‘

env:
  ALIYUN_REGISTRY: crpi-3jw4y17fo5hv6lj8.cn-hangzhou.personal.cr.aliyuncs.com
  IMAGE_NAME: ravey-prod/user-center

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # è·å– tag ç‰ˆæœ¬å·
      - name: Get version from tag
        id: get_version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION="dev-${GITHUB_SHA::8}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Version: ${VERSION}"

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Configure Maven settings
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml << 'EOF'
          <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
                    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                    xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0
                                        http://maven.apache.org/xsd/settings-1.0.0.xsd">
            <servers>
              <server>
                <id>github</id>
                <username>${{ github.actor }}</username>
                <password>${{ secrets.GH_PACKAGES_TOKEN }}</password>
              </server>
            </servers>
          </settings>
          EOF

      # âš ï¸ å…³é”®ï¼šæ·»åŠ å»¶è¿Ÿæˆ–æ£€æŸ¥ä¾èµ–æ˜¯å¦å¯ç”¨
      - name: Wait for dependencies to be available
        run: |
          echo "â³ Waiting 120 seconds for dependencies to be published..."
          sleep 120
          # æˆ–è€…ä½ å¯ä»¥æ·»åŠ ä¸€ä¸ªè„šæœ¬æ¥æ£€æŸ¥ä¾èµ–æ˜¯å¦å·²å‘å¸ƒ

      - name: Build with Maven
        run: |
          cd user-center-start
          mvn clean package -DskipTests
          echo "âœ… Maven build completed"
          ls -lh target/*.jar
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PACKAGES_TOKEN }}

      # â­ å»æ‰ QEMUï¼ˆå•å¹³å°æ„å»ºä¸éœ€è¦ï¼‰
      # - name: Set up QEMU
      #   uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Aliyun Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ALIYUN_REGISTRY }}
          username: ${{ secrets.ALIYUN_USERNAME }}
          password: ${{ secrets.ALIYUN_PASSWORD }}

      # â­ ä¿®æ”¹ï¼šåªæ„å»º linux/amd64 å¹³å°
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./user-center-start
          file: ./user-center-start/Dockerfile
          platforms: linux/amd64  # åªæ„å»º amd64ï¼Œé€‚ç”¨äºé˜¿é‡Œäº‘ Ubuntu x86_64 æœåŠ¡å™¨
          push: true
          tags: |
            ${{ env.ALIYUN_REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.ALIYUN_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.get_version.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Deploy to Aliyun Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: deploy
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            echo "ğŸš€ Starting deployment for version ${{ steps.get_version.outputs.version }}..."
            echo "ğŸ” Logging in to Aliyun Registry..."
            docker login ${{ env.ALIYUN_REGISTRY }} \
              -u "${{ secrets.ALIYUN_USERNAME }}" \
              -p "${{ secrets.ALIYUN_PASSWORD }}"
            cd /opt/user-center
            
            if [ ! -f .env ]; then
              echo "âŒ ERROR: .env file not found!"
              exit 1
            fi
            
            echo "ğŸ“¥ Pulling image version: ${{ steps.get_version.outputs.version }}..."
            docker compose pull
            
            echo "ğŸ”„ Restarting containers..."
            docker compose up -d
            
            sleep 5
            
            echo ""
            echo "ğŸ“Š Container status:"
            docker compose ps
            
            echo ""
            echo "ğŸ“ Latest logs:"
            docker compose logs --tail=50 user-center
            
            echo ""
            echo "âœ… Deployment completed successfully!"
            echo "Version: ${{ steps.get_version.outputs.version }}"

      - name: Deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Deployment succeeded!"
            echo "Version: ${{ steps.get_version.outputs.version }}"
            echo "Image: ${{ env.ALIYUN_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.get_version.outputs.version }}"
          else
            echo "âŒ Deployment failed!"
          fi