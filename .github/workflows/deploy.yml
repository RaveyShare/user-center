name: Build and Push to Aliyun

on:
  push:
    tags:
      - 'v*'  # Âè™Âú®Êé®ÈÄÅ tag Êó∂Ëß¶ÂèëÈÉ®ÁΩ≤
  workflow_dispatch:  # ‰øùÁïôÊâãÂä®Ëß¶Âèë

env:
  ALIYUN_REGISTRY: crpi-3jw4y17fo5hv6lj8.cn-hangzhou.personal.cr.aliyuncs.com
  IMAGE_NAME: ravey-prod/user-center

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Ëé∑Âèñ tag ÁâàÊú¨Âè∑
      - name: Get version from tag
        id: get_version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION="dev-${GITHUB_SHA::8}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "üì¶ Version: ${VERSION}"

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Configure Maven settings
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml << 'EOF'
          <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
                    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                    xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0
                                        http://maven.apache.org/xsd/settings-1.0.0.xsd">
            <servers>
              <server>
                <id>github</id>
                <username>${{ github.actor }}</username>
                <password>${{ secrets.GH_PACKAGES_TOKEN }}</password>
              </server>
            </servers>
          </settings>
          EOF

      - name: Wait for dependencies to be available
        run: |
          echo "‚è≥ Waiting 120 seconds for dependencies to be published..."
          sleep 120

      - name: Build with Maven
        run: |
          cd user-center-start
          mvn clean package -DskipTests
          echo "‚úÖ Maven build completed"
          ls -lh target/*.jar
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PACKAGES_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Aliyun Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ALIYUN_REGISTRY }}
          username: ${{ secrets.ALIYUN_USERNAME }}
          password: ${{ secrets.ALIYUN_PASSWORD }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./user-center-start
          file: ./user-center-start/Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.ALIYUN_REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.ALIYUN_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.get_version.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # üéØ Êñ∞Â¢ûÔºöËß¶ÂèëÊúçÂä°Á´ØÈÉ®ÁΩ≤ Hook
      - name: Trigger deployment hook
        run: |
          echo "üöÄ Triggering deployment for user-center..."
          
          RESPONSE=$(curl -X POST \
            -H "Content-Type: application/json" \
            -H "X-Deploy-Token: ${{ secrets.DEPLOY_HOOK_TOKEN }}" \
            -d '{
              "service": "user-center",
              "version": "${{ steps.get_version.outputs.version }}",
              "image": "${{ env.ALIYUN_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.get_version.outputs.version }}",
              "registry": "${{ env.ALIYUN_REGISTRY }}",
              "triggered_by": "${{ github.actor }}",
              "commit": "${{ github.sha }}",
              "repository": "${{ github.repository }}"
            }' \
            -w "\n%{http_code}" \
            ${{ secrets.DEPLOY_HOOK_URL }})
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "Response: $BODY"
          echo "HTTP Code: $HTTP_CODE"
          
          if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 202 ]; then
            echo "‚úÖ Deployment hook triggered successfully!"
          else
            echo "‚ùå Failed to trigger deployment hook!"
            exit 1
          fi

      - name: Build status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Build and push succeeded!"
            echo "Version: ${{ steps.get_version.outputs.version }}"
            echo "Image: ${{ env.ALIYUN_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.get_version.outputs.version }}"
            echo "Deployment has been triggered on the server."
          else
            echo "‚ùå Build failed!"
          fi