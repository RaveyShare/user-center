name: Build and Deploy to Aliyun

on:
  push:
    branches:
      - main  # æ¨é€åˆ° main åˆ†æ”¯æ—¶è‡ªåŠ¨éƒ¨ç½²
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  # é˜¿é‡Œäº‘é•œåƒä»“åº“é…ç½®
  ALIYUN_REGISTRY: crpi-3jw4y17fo5hv6lj8.cn-hangzhou.personal.cr.aliyuncs.com
  IMAGE_NAME: ravey-prod/user-center

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. è®¾ç½® JDK ç¯å¢ƒ
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'  # ç¼“å­˜ Maven ä¾èµ–ï¼ŒåŠ é€Ÿæ„å»º

      # 3. é…ç½® Maven settings.xml ä»¥è®¿é—® GitHub Packages
      - name: Create Maven settings.xml
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml << 'EOF'
          <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
                    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                    xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0
                                        http://maven.apache.org/xsd/settings-1.0.0.xsd">
            <servers>
              <server>
                <id>github</id>
                <username>${{ github.actor }}</username>
                <password>${{ secrets.GH_PACKAGES_TOKEN }}</password>
              </server>
            </servers>
          </settings>
          EOF
          cat ~/.m2/settings.xml

      # 4. Maven ç¼–è¯‘æ‰“åŒ…
      - name: Build with Maven
        run: |
          cd user-center-start
          mvn clean package -DskipTests
          echo "âœ… Maven build completed"
          ls -lh target/*.jar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 5. è®¾ç½® QEMUï¼ˆæ”¯æŒå¤šæ¶æ„æ„å»ºï¼‰
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      # 6. è®¾ç½® Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 7. ç™»å½•é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡
      - name: Login to Aliyun Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ALIYUN_REGISTRY }}
          username: ${{ secrets.ALIYUN_USERNAME }}
          password: ${{ secrets.ALIYUN_PASSWORD }}

      # 8. æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./user-center-start
          file: ./user-center-start/Dockerfile
          platforms: linux/amd64,linux/arm64  # å¤šæ¶æ„æ”¯æŒ
          push: true
          tags: |
            ${{ env.ALIYUN_REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.ALIYUN_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # 9. éƒ¨ç½²åˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨
      - name: Deploy to Aliyun Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: deploy
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            echo "ğŸš€ Starting deployment..."
            
            cd /opt/user-center
            
            # æ£€æŸ¥ .env æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            if [ ! -f .env ]; then
              echo "âŒ ERROR: .env file not found!"
              echo "Please create /opt/user-center/.env on server first"
              exit 1
            fi
            
            # æ‹‰å–æœ€æ–°é•œåƒ
            echo "ğŸ“¥ Pulling latest image..."
            docker compose pull
            
            # åœæ­¢æ—§å®¹å™¨å¹¶å¯åŠ¨æ–°å®¹å™¨
            echo "ğŸ”„ Restarting containers..."
            docker compose up -d
            
            # ç­‰å¾…å®¹å™¨å¯åŠ¨
            sleep 5
            
            # æ˜¾ç¤ºå®¹å™¨çŠ¶æ€
            echo ""
            echo "ğŸ“Š Container status:"
            docker compose ps
            
            # æ˜¾ç¤ºæœ€æ–°æ—¥å¿—
            echo ""
            echo "ğŸ“ Latest logs:"
            docker compose logs --tail=50 user-center
            
            echo ""
            echo "âœ… Deployment completed successfully!"

      # 10. éƒ¨ç½²ç»“æœé€šçŸ¥ï¼ˆå¯é€‰ï¼‰
      - name: Deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Deployment succeeded!"
            echo "Image: ${{ env.ALIYUN_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
            echo "Deployed by: ${{ github.actor }}"
            echo "Commit: ${{ github.sha }}"
          else
            echo "âŒ Deployment failed!"
          fi